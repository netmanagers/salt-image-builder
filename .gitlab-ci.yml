---
###############################################################################
# Define all YAML node anchors
###############################################################################
.node_anchors:
  # `only` (also used for `except` where applicable)
  only_branch_master_parent_repo: &only_branch_master_parent_repo
    - 'master@saltstack-formulas/infrastructure/salt-image-builder'
  # `stage`
  stage_build: &stage_build 'build'
  stage_lint: &stage_lint 'lint'
  stage_release: &stage_release 'release'
  # `image`
  image_black: &image_black
    name: 'cytopia/black:latest'
    entrypoint: ['/bin/ash', '-c']
  image_commitlint: &image_commitlint 'myii/ssf-commitlint:11'
  # yamllint disable-line rule:line-length
  image_dindpy3virtualenv: &image_dindpy3virtualenv 'myii/ssf-dind-py3-virtualenv:20.0.21-r0'
  image_hadolint: &image_hadolint 'hadolint/hadolint:latest'
  image_semantic-release: &image_semanticrelease 'myii/ssf-semantic-release-gitlab:17.3'
  image_yamllint: &image_yamllint
    name: 'cytopia/yamllint:latest'
    entrypoint: ['/bin/ash', '-c']
  # `script`
  script_dind_push_to_docker_hub: &script_dind_push_to_docker_hub
    - |
      if [ "${CI_COMMIT_BRANCH}" = "master" ]; then
        echo "Push to Docker Hub"
        echo "${DOCKERHUB_PASSWORD}" | \
          docker login -u "${DOCKERHUB_USER}" --password-stdin
        docker tag ${TAG} ${DOCKERHUB_ORG}/${DOCKERHUB_IMAGE}
        docker push ${DOCKERHUB_ORG}/${DOCKERHUB_IMAGE}
      fi
  # `services`
  services_docker_dind: &services_docker_dind
    - 'docker:dind'

###############################################################################
# Define stages and global variables
###############################################################################
stages:
  - *stage_lint
  - *stage_build
  - *stage_release
variables:
  DOCKER_DRIVER: 'overlay2'

###############################################################################
# `lint` stage: `yamllint`, `black`, `hadolint` & `commitlint`
###############################################################################
yamllint:
  stage: *stage_lint
  image: *image_yamllint
  script:
    - 'yamllint -s .'

black:
  stage: *stage_lint
  image: *image_black
  script:
    # The `--check` will provide the failure, if encountered
    # The `--diff` will show any files that need to be fixed
    - 'black --check -v .'
    - 'black --diff .'

hadolint:
  stage: *stage_lint
  image: *image_hadolint
  script:
    - 'find . -maxdepth 1 -type f -name "Dockerfile.*"
                      | xargs hadolint'

commitlint:
  stage: *stage_lint
  image: *image_commitlint
  script:
    # Add `upstream` remote to get access to `upstream/master`
    - 'git remote add upstream
       https://gitlab.com/saltstack-formulas/infrastructure/salt-image-builder.git'
    - 'git fetch --all'
    # Run `commitlint`
    - 'commitlint --from "$(git merge-base upstream/master HEAD)"
                  --to   "${CI_COMMIT_SHA}"
                  --verbose'

###############################################################################
# Define `build` template (`allow_failure: false` -- implicit)
###############################################################################
.build_image_failure_forbidden: &build_image_failure_forbidden
  stage: *stage_build
  image: *image_dindpy3virtualenv
  services: *services_docker_dind
  before_script:
    - 'python3 -m venv venv'
    - 'venv/bin/pip install -r requirements.txt'
    - 'export TAG=$(echo ${DN} | sed "s#/#-#g")-${DV}'
    - |
        if [ "${TAG}" = "archlinux-base-latest" ]; then
          export TAG=arch-base-latest
        fi
    - 'echo "Building: ${TAG}"'
    - 'export DOCKERHUB_IMAGE=salt-${SV}-py${PV}:${TAG}'
    - 'export CACHE_FROM=${DOCKERHUB_ORG}/${DOCKERHUB_IMAGE}'
    - 'docker pull ${CACHE_FROM} || true'
    # Handle version number when installing a `.0` release with `git`,
    # where the `.0` is not present in the version number in PyPI
    # https://pypi.org/project/salt/#history
    - |
        if [ "${SIM}" != "git" ]; then
          export SVFB=${SV}
        else
          export SVFB=$(echo ${SV} | sed "s/\.0$//")
        fi
    - 'docker build .
         --cache-from ${CACHE_FROM}
         --file "Dockerfile.${PI}"
         --tag "${TAG}"
         --build-arg DISTRO_NAME="${DN}"
         --build-arg DISTRO_VERSION="${DV}"
         --build-arg SALT_INSTALL_METHOD="${SIM}"
         --build-arg SALT_VERSION="${SVFB}"
         --build-arg PYTHON_VERSION="${PV}"
         --build-arg EXTRA_PACKAGES="${EP}"'
    - 'export TESTINFRA_CONTAINER=testinfra-${TAG}-${PI}-${PV}-${SIM}-${SV}'
    - 'docker run
         --detach=true
         --name "${TESTINFRA_CONTAINER}"
         "${TAG}" tail -f /dev/null'
    # Not using `${SVFB}` instead of `${SV}` here since that will only be
    # adjusted for `git`-based installations; the test file itself handles the
    # extra `.0` in the version number.
    - 'venv/bin/pytest
         --hosts="docker://${TESTINFRA_CONTAINER}"
         test/integration
         --pyvers "${PV}"
         --saltvers "${SV}"
         --installmethod "${SIM}"
         -v'
    # Display `--versions-report` for debugging purposes
    - 'docker exec "${TESTINFRA_CONTAINER}" salt-call --versions-report'
    - 'docker stop "${TESTINFRA_CONTAINER}"'
    - 'docker rm "${TESTINFRA_CONTAINER}"'
  script: *script_dind_push_to_docker_hub

###############################################################################
# Define `build` template (`allow_failure: true`)
###############################################################################
.build_image_failure_permitted:
  <<: *build_image_failure_forbidden
  allow_failure: true

###############################################################################
# `build` stage: `...`
###############################################################################
# VARS:
# DN:  distro name (amazonlinux, archlinux, centos,      debian, fedora,
#                   gentoo,      opensuse,  oraclelinux, ubuntu)
# DV:  distro version
# PI:  packages installer, used as dockerfile extension (apt, dnf, emg, pac, yum, zyp)
# SIM: salt install method (git, stable)
# SV:  salt version (tiamat, master, 3002.2, 3001.4, 3000.6)
# PV:  python version (3, 2)
# EP:  extra packages required for the specific build

# yamllint disable rule:commas rule:line-length
# AMAZONLINUX
amaz-02.0-tiamat-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'amazonlinux'    , DV: '2'      , PI: 'yum' , SIM: 'stable' , SV: 'tiamat' , PV: '3' , EP: 'yum-utils python3-pip procps-ng'}}
amaz-02.0-master-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'amazonlinux'    , DV: '2'      , PI: 'yum' , SIM: 'git'    , SV: 'master' , PV: '3' , EP: 'yum-utils python3-pip procps-ng'}}
amaz-02.0-3002.2-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'amazonlinux'    , DV: '2'      , PI: 'yum' , SIM: 'stable' , SV: '3002.2' , PV: '3' , EP: 'yum-utils python3-pip procps-ng'}}
amaz-02.0-3001.4-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'amazonlinux'    , DV: '2'      , PI: 'yum' , SIM: 'stable' , SV: '3001.4' , PV: '3' , EP: 'yum-utils python3-pip procps-ng'}}
amaz-02.0-3000.6-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'amazonlinux'    , DV: '2'      , PI: 'yum' , SIM: 'stable' , SV: '3000.6' , PV: '3' , EP: 'yum-utils python3-pip procps-ng'}}

# ARCHLINUX
# The Salt bootstrap installer does not provide packages nor installs with py3 for Arch
# so we're building only the git'ted py2 versions
# NOTE: Removed broken `py2` image for `SV: 'master'` since that's been deprecated in `Sodium` and
#       no working `py3` version available
arch-late-3002.2-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'archlinux/base' , DV: 'latest' , PI: 'pac' , SIM: 'git'    , SV: '3002.2' , PV: '3' , EP: 'openssl openssh awk procps python-pip'}}
arch-late-3001.4-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'archlinux/base' , DV: 'latest' , PI: 'pac' , SIM: 'git'    , SV: '3001.4' , PV: '3' , EP: 'openssl openssh awk procps python-pip'}}
arch-late-3000.6-py2: {extends: '.build_image_failure_forbidden', variables: {DN: 'archlinux/base' , DV: 'latest' , PI: 'pac' , SIM: 'git'    , SV: '3000.6' , PV: '2' , EP: 'openssl openssh awk procps python2-pip'}}

# CENTOS
cent-08.0-tiamat-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'centos'         , DV: '8'      , PI: 'yum' , SIM: 'stable' , SV: 'tiamat' , PV: '3' , EP: 'python3 python3-pip python3-devel openssl-devel swig glibc-langpack-en'}}
cent-08.0-master-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'centos'         , DV: '8'      , PI: 'yum' , SIM: 'git'    , SV: 'master' , PV: '3' , EP: 'python3 python3-pip python3-devel openssl-devel swig glibc-langpack-en'}}
cent-08.0-3002.2-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'centos'         , DV: '8'      , PI: 'yum' , SIM: 'stable' , SV: '3002.2' , PV: '3' , EP: 'python3 python3-pip python3-devel openssl-devel swig glibc-langpack-en'}}
cent-08.0-3001.4-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'centos'         , DV: '8'      , PI: 'yum' , SIM: 'stable' , SV: '3001.4' , PV: '3' , EP: 'python3 python3-pip python3-devel openssl-devel swig glibc-langpack-en'}}
cent-08.0-3000.6-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'centos'         , DV: '8'      , PI: 'yum' , SIM: 'stable' , SV: '3000.6' , PV: '3' , EP: 'python3 python3-pip python3-devel openssl-devel swig glibc-langpack-en'}}
cent-07.0-tiamat-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'centos'         , DV: '7'      , PI: 'yum' , SIM: 'stable' , SV: 'tiamat' , PV: '3' , EP: 'python3 python3-pip python3-devel openssl-devel swig gcc-g++ zeromq zeromq-devel'}}
cent-07.0-master-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'centos'         , DV: '7'      , PI: 'yum' , SIM: 'git'    , SV: 'master' , PV: '3' , EP: 'python3 python3-pip python3-devel openssl-devel swig gcc-g++ zeromq zeromq-devel'}}
cent-07.0-3002.2-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'centos'         , DV: '7'      , PI: 'yum' , SIM: 'stable' , SV: '3002.2' , PV: '3' , EP: 'python3 python3-pip python3-devel openssl-devel swig gcc-g++ zeromq zeromq-devel'}}
cent-07.0-3001.4-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'centos'         , DV: '7'      , PI: 'yum' , SIM: 'stable' , SV: '3001.4' , PV: '3' , EP: 'python3 python3-pip python3-devel openssl-devel swig gcc-g++ zeromq zeromq-devel'}}
cent-07.0-3000.6-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'centos'         , DV: '7'      , PI: 'yum' , SIM: 'stable' , SV: '3000.6' , PV: '3' , EP: 'python3 python3-pip python3-devel openssl-devel swig gcc-g++ zeromq zeromq-devel'}}

# DEBIAN
debi-10.0-tiamat-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'debian'         , DV: '10'     , PI: 'apt' , SIM: 'stable' , SV: 'tiamat' , PV: '3' , EP: 'python3-pip'}}
debi-10.0-master-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'debian'         , DV: '10'     , PI: 'apt' , SIM: 'git'    , SV: 'master' , PV: '3' , EP: 'python3-apt python3-pip'}}
debi-10.0-3002.2-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'debian'         , DV: '10'     , PI: 'apt' , SIM: 'stable' , SV: '3002.2' , PV: '3' , EP: 'python3-pip'}}
debi-10.0-3001.4-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'debian'         , DV: '10'     , PI: 'apt' , SIM: 'stable' , SV: '3001.4' , PV: '3' , EP: 'python3-pip'}}
debi-10.0-3000.6-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'debian'         , DV: '10'     , PI: 'apt' , SIM: 'stable' , SV: '3000.6' , PV: '3' , EP: 'python3-pip'}}
debi-09.0-tiamat-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'debian'         , DV: '9'      , PI: 'apt' , SIM: 'stable' , SV: 'tiamat' , PV: '3' , EP: 'python3-pip'}}
debi-09.0-master-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'debian'         , DV: '9'      , PI: 'apt' , SIM: 'git'    , SV: 'master' , PV: '3' , EP: 'python3-pip'}}
debi-09.0-3002.2-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'debian'         , DV: '9'      , PI: 'apt' , SIM: 'stable' , SV: '3002.2' , PV: '3' , EP: 'python3-pip'}}
debi-09.0-3001.4-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'debian'         , DV: '9'      , PI: 'apt' , SIM: 'stable' , SV: '3001.4' , PV: '3' , EP: 'python3-pip'}}
debi-09.0-3000.6-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'debian'         , DV: '9'      , PI: 'apt' , SIM: 'stable' , SV: '3000.6' , PV: '3' , EP: 'python3-pip'}}

# FEDORA
# Fedora has no python3 packages due to a tornado issue,
# but they ship with Python3 since 29, so we install it using git
# https://bugzilla.redhat.com/show_bug.cgi?id: 1723207
fedo-33.0-master-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'fedora'         , DV: '33'     , PI: 'dnf' , SIM: 'git'    , SV: 'master' , PV: '3' , EP: 'python3-pip'}}
fedo-33.0-3002.2-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'fedora'         , DV: '33'     , PI: 'dnf' , SIM: 'git'    , SV: '3002.2' , PV: '3' , EP: 'python3-pip'}}
fedo-33.0-3001.4-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'fedora'         , DV: '33'     , PI: 'dnf' , SIM: 'git'    , SV: '3001.4' , PV: '3' , EP: 'python3-pip'}}
fedo-32.0-master-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'fedora'         , DV: '32'     , PI: 'dnf' , SIM: 'git'    , SV: 'master' , PV: '3' , EP: 'python3-pip'}}
fedo-32.0-3002.2-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'fedora'         , DV: '32'     , PI: 'dnf' , SIM: 'git'    , SV: '3002.2' , PV: '3' , EP: 'python3-pip'}}
fedo-32.0-3001.4-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'fedora'         , DV: '32'     , PI: 'dnf' , SIM: 'git'    , SV: '3001.4' , PV: '3' , EP: 'python3-pip'}}

# GENTOO
gent-late-master-py3: {extends: '.build_image_failure_permitted', variables: {DN: 'gentoo/stage3'  , DV: 'latest' , PI: 'emg' , SIM: 'git'    , SV: 'master' , PV: '3' , EP: 'dev-python/pip'}}
gent-late-3002.2-py3: {extends: '.build_image_failure_permitted', variables: {DN: 'gentoo/stage3'  , DV: 'latest' , PI: 'emg' , SIM: 'stable' , SV: '3002.2' , PV: '3' , EP: 'dev-python/pip'}}
gent-late-3001.4-py3: {extends: '.build_image_failure_permitted', variables: {DN: 'gentoo/stage3'  , DV: 'latest' , PI: 'emg' , SIM: 'stable' , SV: '3001.4' , PV: '3' , EP: 'dev-python/pip'}}
gent-late-3000.6-py3: {extends: '.build_image_failure_permitted', variables: {DN: 'gentoo/stage3'  , DV: 'latest' , PI: 'emg' , SIM: 'stable' , SV: '3000.6' , PV: '3' , EP: 'dev-python/pip'}}
gent-sysd-master-py3: {extends: '.build_image_failure_permitted', variables: {DN: 'gentoo/stage3'  , DV: 'systemd', PI: 'emg' , SIM: 'git'    , SV: 'master' , PV: '3' , EP: 'dev-python/pip'}}
gent-sysd-3002.2-py3: {extends: '.build_image_failure_permitted', variables: {DN: 'gentoo/stage3'  , DV: 'systemd', PI: 'emg' , SIM: 'stable' , SV: '3002.2' , PV: '3' , EP: 'dev-python/pip'}}
gent-sysd-3001.4-py3: {extends: '.build_image_failure_permitted', variables: {DN: 'gentoo/stage3'  , DV: 'systemd', PI: 'emg' , SIM: 'stable' , SV: '3001.4' , PV: '3' , EP: 'dev-python/pip'}}
gent-sysd-3000.6-py3: {extends: '.build_image_failure_permitted', variables: {DN: 'gentoo/stage3'  , DV: 'systemd', PI: 'emg' , SIM: 'stable' , SV: '3000.6' , PV: '3' , EP: 'dev-python/pip'}}

# OPENSUSE
opsu-15.2-master-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'opensuse/leap'  , DV: '15.2'   , PI: 'zyp' , SIM: 'git'    , SV: 'master' , PV: '3' , EP: 'python3-pip'}}
opsu-15.2-3002.2-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'opensuse/leap'  , DV: '15.2'   , PI: 'zyp' , SIM: 'git'    , SV: '3002.2' , PV: '3' , EP: 'python3-pip'}}
opsu-15.2-3001.4-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'opensuse/leap'  , DV: '15.2'   , PI: 'zyp' , SIM: 'git'    , SV: '3001.4' , PV: '3' , EP: 'python3-pip'}}
opsu-15.2-3000.6-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'opensuse/leap'  , DV: '15.2'   , PI: 'zyp' , SIM: 'git'    , SV: '3000.6' , PV: '3' , EP: 'python3-pip'}}

# ORACLELINUX
orac-08.0-tiamat-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'oraclelinux'    , DV: '8'      , PI: 'yum' , SIM: 'stable' , SV: 'tiamat' , PV: '3' , EP: 'python3 python3-pip python3-devel openssl-devel swig glibc-langpack-en'}}
orac-08.0-master-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'oraclelinux'    , DV: '8'      , PI: 'yum' , SIM: 'git'    , SV: 'master' , PV: '3' , EP: 'python3 python3-pip python3-devel openssl-devel swig glibc-langpack-en'}}
orac-08.0-3002.2-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'oraclelinux'    , DV: '8'      , PI: 'yum' , SIM: 'stable' , SV: '3002.2' , PV: '3' , EP: 'python3 python3-pip python3-devel openssl-devel swig glibc-langpack-en'}}
orac-08.0-3001.4-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'oraclelinux'    , DV: '8'      , PI: 'yum' , SIM: 'stable' , SV: '3001.4' , PV: '3' , EP: 'python3 python3-pip python3-devel openssl-devel swig glibc-langpack-en'}}
orac-08.0-3000.6-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'oraclelinux'    , DV: '8'      , PI: 'yum' , SIM: 'stable' , SV: '3000.6' , PV: '3' , EP: 'python3 python3-pip python3-devel openssl-devel swig glibc-langpack-en'}}
orac-07.0-tiamat-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'oraclelinux'    , DV: '7'      , PI: 'yum' , SIM: 'stable' , SV: 'tiamat' , PV: '3' , EP: 'python3 python3-pip python3-devel openssl-devel swig gcc-g++ zeromq zeromq-devel'}}
# Fails due to dependency issues, probably ignore permanently
# orac-07.0-master-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'oraclelinux'    , DV: '7'      , PI: 'yum' , SIM: 'git'    , SV: 'master' , PV: '3' , EP: 'python3 python3-pip python3-devel openssl-devel swig gcc-g++ zeromq zeromq-devel'}}
orac-07.0-3002.2-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'oraclelinux'    , DV: '7'      , PI: 'yum' , SIM: 'stable' , SV: '3002.2' , PV: '3' , EP: 'python3 python3-pip python3-devel openssl-devel swig gcc-g++ zeromq zeromq-devel'}}
orac-07.0-3001.4-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'oraclelinux'    , DV: '7'      , PI: 'yum' , SIM: 'stable' , SV: '3001.4' , PV: '3' , EP: 'python3 python3-pip python3-devel openssl-devel swig gcc-g++ zeromq zeromq-devel'}}
orac-07.0-3000.6-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'oraclelinux'    , DV: '7'      , PI: 'yum' , SIM: 'stable' , SV: '3000.6' , PV: '3' , EP: 'python3 python3-pip python3-devel openssl-devel swig gcc-g++ zeromq zeromq-devel'}}

# UBUNTU
ubun-20.0-tiamat-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'ubuntu'         , DV: '20.04'  , PI: 'apt' , SIM: 'stable' , SV: 'tiamat' , PV: '3' , EP: 'python3-pip'}}
ubun-20.0-master-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'ubuntu'         , DV: '20.04'  , PI: 'apt' , SIM: 'git'    , SV: 'master' , PV: '3' , EP: 'python3-apt python3-pip'}}
ubun-20.0-3002.2-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'ubuntu'         , DV: '20.04'  , PI: 'apt' , SIM: 'stable' , SV: '3002.2' , PV: '3' , EP: 'python3-pip'}}
ubun-20.0-3001.4-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'ubuntu'         , DV: '20.04'  , PI: 'apt' , SIM: 'stable' , SV: '3001.4' , PV: '3' , EP: 'python3-pip'}}
ubun-18.0-tiamat-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'ubuntu'         , DV: '18.04'  , PI: 'apt' , SIM: 'stable' , SV: 'tiamat' , PV: '3' , EP: 'python3-pip'}}
ubun-18.0-master-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'ubuntu'         , DV: '18.04'  , PI: 'apt' , SIM: 'git'    , SV: 'master' , PV: '3' , EP: 'python3-apt python3-pip'}}
ubun-18.0-3002.2-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'ubuntu'         , DV: '18.04'  , PI: 'apt' , SIM: 'stable' , SV: '3002.2' , PV: '3' , EP: 'python3-pip'}}
ubun-18.0-3001.4-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'ubuntu'         , DV: '18.04'  , PI: 'apt' , SIM: 'stable' , SV: '3001.4' , PV: '3' , EP: 'python3-pip'}}
ubun-18.0-3000.6-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'ubuntu'         , DV: '18.04'  , PI: 'apt' , SIM: 'stable' , SV: '3000.6' , PV: '3' , EP: 'python3-pip'}}
ubun-18.0-3000.6-py2: {extends: '.build_image_failure_forbidden', variables: {DN: 'ubuntu'         , DV: '18.04'  , PI: 'apt' , SIM: 'stable' , SV: '3000.6' , PV: '2' , EP: 'python-pip'}}
ubun-16.0-tiamat-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'ubuntu'         , DV: '16.04'  , PI: 'apt' , SIM: 'stable' , SV: 'tiamat' , PV: '3' , EP: 'python3-pip'}}
ubun-16.0-master-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'ubuntu'         , DV: '16.04'  , PI: 'apt' , SIM: 'git'    , SV: 'master' , PV: '3' , EP: 'python3-pip'}}
ubun-16.0-3002.2-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'ubuntu'         , DV: '16.04'  , PI: 'apt' , SIM: 'stable' , SV: '3002.2' , PV: '3' , EP: 'python3-pip'}}
ubun-16.0-3001.4-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'ubuntu'         , DV: '16.04'  , PI: 'apt' , SIM: 'stable' , SV: '3001.4' , PV: '3' , EP: 'python3-pip'}}
ubun-16.0-3000.6-py3: {extends: '.build_image_failure_forbidden', variables: {DN: 'ubuntu'         , DV: '16.04'  , PI: 'apt' , SIM: 'stable' , SV: '3000.6' , PV: '3' , EP: 'python3-pip'}}
ubun-16.0-3000.6-py2: {extends: '.build_image_failure_forbidden', variables: {DN: 'ubuntu'         , DV: '16.04'  , PI: 'apt' , SIM: 'stable' , SV: '3000.6' , PV: '2' , EP: 'python-pip'}}
# yamllint enable rule:commas rule:line-length

###############################################################################
# `release` stage: `semantic-release`
###############################################################################
semantic-release:
  only: *only_branch_master_parent_repo
  stage: *stage_release
  image: *image_semanticrelease
  script:
    - 'semantic-release'
